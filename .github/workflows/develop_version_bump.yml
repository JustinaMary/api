name: 'Bump Patch Version'

on:
    push:
        branches:
            - 'develop'

jobs:
    bump-version:
        runs-on: ubuntu-latest

        steps:
            - name: 'Checkout source code'
              uses: 'actions/checkout@v2'
              with:
                  ref: ${{ github.ref }}
            - name: 'Setup Node.js'
              uses: 'actions/setup-node@v1'
              with:
                  node-version: 10
            - name: 'Bump Patch Version'
              run: |
                  git config --global user.email "version.bot@thx.network"
                  git config --global user.name "ðŸ¤– Version Bot"
                  npm version patch
                  VERSION=`cat package.json | grep 'version' | sed 's/[^0-9\.]//g'`
                  git tag $VERSION
              env:
                  GITHUB_TOKEN: ${{ secrets.VERSION_BUMP_TOKEN }}
            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v3
              with:
                  token: ${{ secrets.VERSION_BUMP_TOKEN }}
                  commit-message: Update report
                  committer: GitHub <noreply@github.com>
                  author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
                  signoff: false
                  branch: automerge/version
                  labels: automerge
                  delete-branch: true
                  title: Bump Patch Version
                  body: Patches package version.
              env:
                  GITHUB_TOKEN: ${{ secrets.VERSION_BUMP_TOKEN }}
            - name: Approve Pull Request
              uses: hmarr/auto-approve-action@v2.0.0
              if: github.actor == 'ðŸ¤– Version Bot'
              with:
                  github-token: '${{ secrets.VERSION_BUMP_TOKEN }}'
            - name: Merge Pull Request
              uses: 'pascalgn/automerge-action@v0.11.0'
              env:
                  GITHUB_TOKEN: '${{ secrets.VERSION_BUMP_TOKEN }}'
                  MERGE_LABELS: 'automerge'
                  MERGE_DELETE_BRANCH: true
                  MERGE_RETRIES: 6
                  MERGE_RETRY_SLEEP: 5000
            - name: 'Display Patch Version'
              run: cat ./package.json | grep "version"
